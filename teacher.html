<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teacher Dashboard — Student-Teacher Booking</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f2f2f2; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header { display:flex; justify-content: space-between; align-items: center; margin-bottom:20px; }
    h1 { margin:0; }
    .top-actions { display:flex; gap:10px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
    .card { background:white; padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); display:flex; flex-direction:column; }
    input, select { flex:1; padding:8px; border-radius:4px; border:1px solid #ccc; }
    button { padding:8px 12px; border:none; border-radius:4px; background:#007BFF; color:white; cursor:pointer; }
    button:hover { background:#0056b3; }
    .list { max-height:250px; overflow-y:auto; border:1px solid #eee; padding:5px; border-radius:4px; margin-top:10px; }
    .appt-item, .schedule-item, .student-item { border-bottom:1px solid #eee; padding:5px; }
    .student-item { cursor:pointer; }
    .student-item.selected { background:#d0f0ff; }
    .chat-container { display:flex; height:350px; border:1px solid #eee; border-radius:4px; overflow:hidden; margin-top:10px; }
    .chat-students { width:30%; border-right:1px solid #ccc; overflow-y:auto; }
    .chat-messages { flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; }
    .message { margin-bottom:10px; padding:5px 10px; border-radius:15px; max-width:70%; word-wrap: break-word; }
    .message.teacher { background:#007BFF; color:white; margin-left:auto; }
    .message.student { background:#eee; color:black; margin-right:auto; }
    .message.system { background:#ffc107; color:black; margin-left:auto; font-style:italic; }
    .message-time { font-size:0.7em; color:#666; margin-top:2px; }
    .message-form { display:flex; gap:5px; margin-top:5px; }
    .message-form input { flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; }
  </style>
</head>
<body>
<main class="container">
  <header>
    <h1>Teacher Dashboard</h1>
    <div class="top-actions">
      <span id="teacher-welcome"></span>
      <button id="btn-logout">Logout</button>
    </div>
  </header>

  <section class="grid">
    <div class="card">
      <h2>Schedule Availability</h2>
      <form id="schedule-form" class="inline-form">
        <input id="s-date" type="date" required />
        <input id="s-time" type="time" required />
        <input id="s-duration" type="number" placeholder="Duration (mins)" value="30" />
        <button type="submit">Add Slot</button>
      </form>
      <div id="schedule-list" class="list"></div>

      <h2>Appointments</h2>
      <div id="appointments-list" class="list"></div>
    </div>

    <div class="card">
      <h2>Messages</h2>
      <div class="chat-container">
        <div id="students-list" class="chat-students"></div>
        <div class="chat-messages" id="messages-list"></div>
      </div>
      <div class="message-form">
        <input id="messageText" type="text" placeholder="Type a message">
        <button id="btnSendMessage">Send</button>
      </div>
    </div>
  </section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, where, doc, getDoc, orderBy, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBBhGPM46kUg1exY-000CttB8cjAegeCaQ",
  authDomain: "guruvandan-d4dc0.firebaseapp.com",
  projectId: "guruvandan-d4dc0",
  storageBucket: "guruvandan-d4dc0.firebasestorage.app",
  messagingSenderId: "547247846451",
  appId: "1:547247846451:web:9bf630619fe89e5d21df46",
  measurementId: "G-5DT4H1SK83"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let selectedStudentUid = null;

const welcome = document.getElementById("teacher-welcome");
const scheduleList = document.getElementById("schedule-list");
const appointmentsList = document.getElementById("appointments-list");
const studentsList = document.getElementById("students-list");
const messagesList = document.getElementById("messages-list");

// Auth listener
onAuthStateChanged(auth, async user => {
  if (!user) location.href = "index.html";
  const userDoc = await getDoc(doc(db, "users", user.uid));
  if (!userDoc.exists() || userDoc.data().role !== "teacher") {
    alert("Access denied!");
    location.href = "index.html";
    return;
  }
  currentUser = { uid: user.uid, ...userDoc.data() };
  welcome.textContent = `Hi, ${currentUser.name}`;
  loadSchedule();
  loadAppointments();
  loadStudents();
});

// Logout
document.getElementById("btn-logout").addEventListener("click", () => signOut(auth));

// Schedule Availability
document.getElementById("schedule-form").addEventListener("submit", async e => {
  e.preventDefault();
  const date = document.getElementById("s-date").value;
  const time = document.getElementById("s-time").value;
  const duration = parseInt(document.getElementById("s-duration").value) || 30;
  if (!date || !time) return alert("Date and time required");
  await addDoc(collection(db, "schedule"), { teacherId: currentUser.uid, date, time, duration });
  loadSchedule();
});

async function loadSchedule() {
  scheduleList.innerHTML = "";
  const qSnap = await getDocs(query(collection(db, "schedule"), where("teacherId", "==", currentUser.uid)));
  qSnap.forEach(docSnap => {
    const s = docSnap.data();
    const div = document.createElement("div");
    div.className = "schedule-item";
    div.textContent = `${s.date} ${s.time} (${s.duration} mins)`;
    scheduleList.appendChild(div);
  });
}

// Appointments
async function loadAppointments() {
  appointmentsList.innerHTML = "";
  const qSnap = await getDocs(
    query(collection(db, "appointments"), where("teacherUid", "==", currentUser.uid))
  );
  qSnap.forEach(docSnap => {
    const a = docSnap.data();
    const div = document.createElement("div");
    div.className = "appt-item";
    div.dataset.id = docSnap.id;
    div.innerHTML = `
      ${a.date} ${a.time} — ${a.purpose} (Student: ${a.studentName}) [${a.status || "pending"}]
      <button class="btn-approve">${a.status === "approved" ? "Approved" : "Approve"}</button>
      <button class="btn-cancel">${a.status === "cancelled" ? "Cancelled" : "Cancel"}</button>
    `;
    appointmentsList.appendChild(div);
  });
}

// Handle approve/cancel
appointmentsList.addEventListener("click", async e => {
  const apptId = e.target.closest(".appt-item")?.dataset?.id;
  if (!apptId) return;
  const ref = doc(db, "appointments", apptId);
  const apptDoc = await getDoc(ref);
  const a = apptDoc.data();
  let newStatus = "";
  if (e.target.matches(".btn-approve")) newStatus = "approved";
  else if (e.target.matches(".btn-cancel")) newStatus = "cancelled";
  if (!newStatus) return;

  await updateDoc(ref, { status: newStatus });

  // Send system message to the student only
  await addDoc(collection(db, "messages"), {
    senderUid: "system",
    teacherUid: currentUser.uid,
    recipients: [a.studentUid],
    text: `Your appointment on ${a.date} ${a.time} has been ${newStatus} by ${currentUser.name}.`,
    timestamp: serverTimestamp()
  });

  loadAppointments();
});

// Messaging
async function loadStudents() {
  studentsList.innerHTML = "";
  const usersSnap = await getDocs(collection(db, "users"));
  usersSnap.forEach(docSnap => {
    const u = docSnap.data();
    if (u.role === "student") {
      const div = document.createElement("div");
      div.className = "student-item";
      div.dataset.uid = docSnap.id;
      div.textContent = u.name;
      div.addEventListener("click", () => {
        document.querySelectorAll(".student-item").forEach(e => e.classList.remove("selected"));
        div.classList.add("selected");
        selectedStudentUid = docSnap.id;
        loadMessages();
      });
      studentsList.appendChild(div);
    }
  });
}

async function loadMessages() {
  if (!selectedStudentUid) return;
  messagesList.innerHTML = "";
  const qSnap = await getDocs(query(collection(db, "messages"), orderBy("timestamp")));
  qSnap.forEach(docSnap => {
    const m = docSnap.data();
    if ((m.senderUid === selectedStudentUid && m.recipients.includes(currentUser.uid)) ||
        (m.senderUid === currentUser.uid && m.recipients.includes(selectedStudentUid)) ||
        (m.senderUid === "system" && m.recipients.includes(selectedStudentUid) && m.teacherUid === currentUser.uid)) {
      const div = document.createElement("div");
      if (m.senderUid === "system") div.className = "message system";
      else div.className = "message " + (m.senderUid === currentUser.uid ? "teacher" : "student");
      const time = m.timestamp?.seconds ? new Date(m.timestamp.seconds * 1000).toLocaleString() : "";
      div.innerHTML = `<div>${m.text}</div><div class="message-time">${time}</div>`;
      messagesList.appendChild(div);
    }
  });
  messagesList.scrollTop = messagesList.scrollHeight;
}

// Send message
document.getElementById("btnSendMessage").addEventListener("click", async () => {
  const text = document.getElementById("messageText").value.trim();
  if (!selectedStudentUid) return alert("Select a student first!");
  if (!text) return alert("Message cannot be empty!");
  await addDoc(collection(db, "messages"), {
    senderUid: currentUser.uid,
    senderName: currentUser.name,
    recipients: [selectedStudentUid],
    text,
    timestamp: serverTimestamp()
  });
  document.getElementById("messageText").value = "";
  loadMessages();
});
</script>
</body>
</html>
